name: User App CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ '*' ]

jobs:

  user_app_ci:

    runs-on: ubuntu-latest

    steps:

      - uses: actions/checkout@v2
      - name: Start minikube
        uses: medyagh/setup-minikube@master

      - name: Try the cluster !
        run: kubectl get pods -A

      - name: Build image
        run: |
          export SHELL=/bin/bash
          eval $(minikube -p minikube docker-env)
          docker build -t user-app ./app
          docker build -t user-service ./user_service
          echo -n "verifying images:"
          docker images

      - name: Load images to minikube
        run: |
          minikube image load user-app:latest
          minikube image load user-service:latest

      - name: Deploy to minikube
        run: | 
          kubectl apply -f infrastructure/my_network-networkpolicy.yaml
          kubectl apply -f infrastructure/user-app-deployment.yaml
          kubectl apply -f infrastructure/user-app-service.yaml
          kubectl apply -f infrastructure/user-service-deployment.yaml
          kubectl apply -f infrastructure/user-service-service.yaml

      - name: Test service URLs
        run: |
          minikube service list
          minikube service example --url
          echo "------------------opening the service------------------"
          curl $(minikube service example --url)